    Extract comprehensive invoice data from this document as JSON.
    
    ## DOCUMENT TYPE DETECTION
    
    First, identify the document type:
    
    **INVOICE/COMMERCIAL INVOICE:**
    - Contains: Invoice number, vendor, amounts, line items
    - Purpose: Payment request, customs clearance
    - Extract: Full details including line items
    
    **RECEIPT:**
    - Contains: Transaction completed, payment method
    - Purpose: Proof of payment
    - Extract: Summary level sufficient (line items optional if < 5 items)
    
    **TAX INVOICE (Australian):**
    - Contains: ABN, GST breakdown
    - Purpose: Tax compliance
    - Extract: ABN mandatory, GST details critical
    
    **PRO FORMA INVOICE:**
    - Flag as: "Pro Forma - Not for payment"
    - Extract same fields but note status
    
    ## CORE FIELDS - ALWAYS EXTRACT
    
    **Header Information (Required):**
    - "Vendor": Vendor/supplier name (clean, no extra text)
    - "InvoiceNum": Invoice number/reference (or "N/A" if receipt)
    - "Date": Invoice date (standardize to YYYY-MM-DD format)
    - "Currency": Document currency (default to AUD if Australian vendor, or extract from document)
    
    **Financial Totals (Required):**
    - "Cost": Subtotal (before tax, numeric, no currency symbols)
    - "GST": Tax/GST amount (numeric, use "N/A" if exempt/international/not listed)
    - "FinalAmount": Total amount payable (numeric, no currency symbols)
    
    **Financial Validation:**
    - Verify: Subtotal + Tax = Total (within $0.01 tolerance)
    - If Australian vendor: Check for ABN and GST
    - If international: Currency must be specified
    
    ## LINE ITEMS EXTRACTION - CRITICAL ENHANCEMENT
    
    **When to Extract Line Items:**
    Extract line items when:
    - Invoice has itemized table/list
    - More than 2 distinct products/services
    - Quantities and unit prices are listed
    
    Skip line items when:
    - Simple receipt (< 5 items)
    - Only summary available
    - User requests summary only
    
    **Line Item Format:**
    Each line item object should contain:
    - "ItemNumber": Line/item number (if present, otherwise auto-number: "001", "002", etc.)
    - "PartNumber": Part/product number/SKU (critical for inventory, use "N/A" if not present)
    - "HSCode": HS/tariff code per line item (format: "XXXX.XX.XX", optional)
    - "Description": Item description/product name (clean, no formatting artifacts)
    - "Quantity": Quantity (numeric only, extract unit if separate)
    - "UnitPrice": Unit price (decimal format, numeric)
    - "LineTotal": Line total amount (Qty × Unit Price, numeric)
    - "Currency": Currency for this line (if different from invoice total)
    
    **Line Item Extraction Protocol:**
    
    STEP 1: Identify table structure
    - Locate headers: Line/Item #, Part #, Description, Qty, Unit Price, Total
    - Map columns (may have different names: "Item", "Product", "SKU", "Part No", etc.)
    - Note multi-page continuation markers
    
    STEP 2: Extract each row
    For each line item:
    - Extract all available fields
    - Handle merged cells/wrapped text (combine continuation lines into single description)
    - Don't create duplicate line items from subtotals
    
    STEP 3: Validate extraction
    - Calculate: Σ(line totals) should equal invoice subtotal
    - Check: All required fields populated
    - Flag: Missing part numbers or quantities
    - Warn: If calculated total ≠ invoice total (>$0.50 difference)
    
    STEP 4: Handle pagination
    - Note "CONTINUED ON PAGE X" markers
    - Consolidate items across pages
    - Verify total line count matches invoice claim
    
    **Common Line Item Challenges:**
    - MULTI-PAGE INVOICES: Track continuation across pages, aggregate all items
    - MERGED CELLS: Description may span multiple rows, combine into single description
    - SUBTOTALS: Ignore intermediate subtotals, only extract individual line items
    - MISSING COLUMNS: If no Part #, use "N/A"; if no HS code, skip (optional); if no Line #, auto-number
    
    ## BUSINESS CONTEXT EXTRACTION
    
    **Tax Compliance Fields:**
    For Australian Invoices:
    - "ABN": Extract 11-digit number (format: XX XXX XXX XXX, use "N/A" if not present)
    - "GSTIncluded": Note if "GST Included" or separate line (boolean or "N/A")
    - "TaxInvoice": Flag if explicitly stated "Tax Invoice" (boolean)
    
    For International Invoices:
    - "CountryOfOrigin": Country of origin (if specified)
    - "HSCodes": Array of HS codes (per line item or overall)
    - "CustomsDeclaration": Customs declaration statements (if present)
    
    **Purchase Order Tracking:**
    - "POReference": PO Number (look for "PO Ref", "PO #", "Purchase Order", clean format: "AU-PO-77441" not "PO REF: AU-PO-77441")
    - "CustomerReference": Customer reference number (if present)
    - "ProjectNumber": Project number (if present)
    
    **Payment Terms:**
    - "PaymentTerms": Payment terms (e.g., "NET 30 DAYS", "60 DAYS FROM B/L DATE")
    - "DueDate": Due date (calculate from invoice date + terms, format YYYY-MM-DD)
    - "PaymentMethod": Payment method if specified (Wire, LC, etc.)
    
    **Shipping Information (International):**
    For commercial invoices with shipping:
    - "ShippingTerms": Incoterms (FOB, CIF, DAP, EXW, DDP, FCA, CFR, CPT, etc.)
    - "PortOfLoading": Port of loading with code (e.g., "SHENZHEN (CNSZN)")
    - "PortOfDischarge": Port of discharge with code (e.g., "BRISBANE (AUBNE)")
    - "VesselVoyage": Vessel/voyage number (e.g., "MAERSK BRISBANE V.240W")
    - "BillOfLading": Bill of Lading reference
    - "AirWaybill": Air Waybill number (if airfreight)
    
    ## VALIDATION & QUALITY CHECKS
    
    **Mandatory Validation:**
    
    FINANCIAL VALIDATION:
    Subtotal + Tax = Total (tolerance: ±$0.10)
    All line totals sum to subtotal (tolerance: ±$1.00)
    Unit price × Quantity = Line total (per line)
    Currency consistent throughout
    
    FLAG IF:
    ⚠️ Totals don't match Add to flags: "Calculation mismatch - verify manually"
    ⚠️ Missing currency Add to flags: "Currency not specified - assumed [X]"
    ⚠️ Tax rate unusual Add to flags: "GST 10% expected for AU, found X%"
    
    CRITICAL IF:
    ⚠ Total amount missing "CRITICAL: Cannot determine payable amount"
    ⚠ Vendor name unclear "CRITICAL: Vendor identification uncertain"
    
    **Business Rule Validation:**
    
    AUSTRALIAN INVOICES:
    - Must have ABN if > $82.50 (GST threshold)
    - GST should be 10% of subtotal
    - "Tax Invoice" required for GST claims
    
    INTERNATIONAL INVOICES:
    - Currency must be specified
    - HS codes required for customs (flag if missing)
    - Incoterms should be present (flag if missing)
    
    PAYMENT TERMS:
    - If "Net X Days": Calculate due date
    - If date-specific: Extract as-is
    - If missing: Flag as "Payment terms not specified"
    
    ## SUMMARY GENERATION
    
    **Intelligent Summary Rules:**
    Instead of generic descriptions, create intelligent summaries:
    
    For invoices with line items:
    - Mention item count
    - Categorize items logically (e.g., "Hydraulic components, Engine parts, Mechanical")
    - Highlight 2-3 most expensive items
    - Keep under 100 characters if possible
    
    Example:
    ✗ DON'T: "Construction and forestry parts"
    ✓ DO: "20 line items: Hydraulic components (filters, cylinders), Engine parts (gaskets, pistons). Major: Hydraulic cylinders ($4,000), Bearings ($2,400)"
    
    For simple receipts:
    - Brief description of transaction type
    - Payment method if relevant
    
    ## ERROR HANDLING & EDGE CASES
    
    **Missing Information:**
    - Invoice Number: Try "Receipt #", "Ref #", or mark "N/A"
    - Date: Try multiple formats, flag if ambiguous
    - Total: CRITICAL - must find or flag for manual review
    - Currency: Infer from vendor location if not stated
    
    **Calculation Mismatches:**
    If totals don't add up:
    1. Re-check extraction (common: missed a line item)
    2. Check for shipping/handling fees
    3. Check for discounts/adjustments
    4. If still mismatch > $1.00:
       Flag: "⚠️ Calculation discrepancy: Calculated $X vs Invoice $Y"
       Use invoice stated total (assume correct)
       Note for manual verification
    
    **Multi-Currency:**
    If line items in different currency than total:
    - Note exchange rate if provided
    - Flag conversion if not clear
    - Example: "Items in EUR, Total in USD @ 1.08 rate"
    
    ## OUTPUT FORMAT
    
    Return a JSON object with this structure:
    
    {{
      "Vendor": "vendor name",
      "Date": "YYYY-MM-DD",
      "InvoiceNum": "invoice number or N/A",
      "Currency": "AUD/USD/etc",
      "Cost": numeric_subtotal,
      "GST": numeric_tax_or_N/A,
      "FinalAmount": numeric_total,
      "Summary": "intelligent summary with item count and categorization",
      "LineItems": [
    {{
      "ItemNumber": "001",
      "PartNumber": "part number or N/A",
      "HSCode": "XXXX.XX.XX or N/A",
      "Description": "item description",
      "Quantity": numeric_quantity,
      "UnitPrice": numeric_price,
      "LineTotal": numeric_total,
      "Currency": "currency if different"
    }}
      ],
      "ABN": "11-digit ABN or N/A",
      "POReference": "PO number or N/A",
      "PaymentTerms": "payment terms or N/A",
      "DueDate": "YYYY-MM-DD or N/A",
      "ShippingTerms": "Incoterms or N/A",
      "PortOfLoading": "port with code or N/A",
      "PortOfDischarge": "port with code or N/A",
      "VesselVoyage": "vessel info or N/A",
      "BillOfLading": "B/L reference or N/A",
      "HSCodes": ["array of HS codes if present"],
      "Flags": ["array of validation flags and warnings"]
    }}
    
    **Important:**
    - Use empty array [] for LineItems if no line items present
    - Use empty array [] for HSCodes if none present
    - Use empty array [] for Flags if no issues
    - Use "N/A" for missing string fields
    - Calculate line item totals and validate against invoice subtotal
    - Include validation flags for any discrepancies or uncertainties
    
    Return ONLY valid JSON (no markdown, no explanation, no code blocks).

    TEXT: {text}
