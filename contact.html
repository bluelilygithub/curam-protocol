<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contact Us. | Curam-Ai Protocol‚Ñ¢</title>
    <meta
      name="description"
      content="Get in touch with Curam-Ai. Book a diagnostic call, start a Feasibility Sprint, or ask our AI assistant about document automation solutions."
    />
    <link rel="icon" type="image/png" href="assets/images/curam-ai-logo.png" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Loading spinner - using search-loading from styles.css */
      .contact-msg-bubble a {
        color: #0066cc !important;
        text-decoration: underline !important;
        font-weight: 600 !important;
        transition: color 0.2s ease;
      }
      .contact-msg-bubble a:hover {
        color: #004499 !important;
      }
      /* Source links styling */
      .contact-chat-sources a {
        color: #0066cc !important;
        text-decoration: underline !important;
        font-weight: 600 !important;
      }
      .contact-chat-sources a:hover {
        color: #004499 !important;
      }
      .contact-chat-sources p {
        margin: 0 0 8px 0;
        font-weight: 700;
        color: var(--color-navy);
        font-size: 0.85rem;
      }
      .contact-chat-sources ul {
        margin: 0;
        padding-left: 20px;
        list-style: none;
      }
      .contact-chat-sources li {
        margin-bottom: 6px;
      }
      /* Follow-up questions */
      .chat-followup {
        margin-top: 16px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.03) 0%, rgba(15, 23, 42, 0.06) 100%);
        border-left: 4px solid var(--color-navy);
        border-radius: 8px;
      }
      .chat-followup p {
        margin: 0 0 10px 0;
        font-weight: 700;
        color: var(--color-navy);
        font-size: 0.85rem;
      }
      .chat-followup-btn {
        display: block;
        background: transparent;
        border: 2px solid var(--color-gold);
        color: var(--color-navy);
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        cursor: pointer;
        text-align: left;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        width: 100%;
      }
      .chat-followup-btn:hover {
        background: var(--color-gold);
        color: var(--color-navy);
        font-weight: 600;
      }
      /* Microphone button styles */
      .contact-chat-mic-btn {
        background: transparent;
        border: 2px solid var(--color-navy);
        color: var(--color-navy);
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }
      .contact-chat-mic-btn:hover {
        background: var(--color-navy);
        color: white;
      }
      .contact-chat-mic-btn.recording {
        background: #dc2626;
        border-color: #dc2626;
        color: white;
        animation: pulse-recording 1.5s ease-in-out infinite;
      }
      .contact-chat-mic-btn.recording svg {
        animation: pulse-icon 0.8s ease-in-out infinite;
      }
      @keyframes pulse-recording {
        0%, 100% {
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
        }
      }
      @keyframes pulse-icon {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      .contact-chat-mic-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .contact-chat-mic-btn.error {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Scroll Down Button -->
    <button class="scroll-down-btn" aria-label="Scroll down">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M19 12l-7 7-7-7" />
      </svg>
    </button>

    <!-- Navigation -->
    <div id="navbar-placeholder"></div>
    <script src="assets/js/navbar-loader.js"></script>

    <!-- Page Header / Hero -->
    <section class="hero services-hero">
      <div class="hero-background">
        <div class="hero-gradient"></div>
        <div class="hero-pattern"></div>
        <svg class="hero-abstract hero-abstract-1" viewBox="0 0 200 200" fill="none">
            <circle cx="100" cy="100" r="80" stroke="var(--cyan-accent)" stroke-width="0.5" opacity="0.3"/>
            <circle cx="100" cy="100" r="60" stroke="var(--cyan-accent)" stroke-width="0.5" opacity="0.2"/>
            <circle cx="100" cy="100" r="40" stroke="var(--cyan-accent)" stroke-width="0.5" opacity="0.1"/>
        </svg>
        <svg class="hero-abstract hero-abstract-2" viewBox="0 0 300 300" fill="none">
            <path d="M150 20 Q280 150 150 280 Q20 150 150 20" stroke="var(--color-gold)" stroke-width="0.5" fill="none" opacity="0.2"/>
        </svg>
      </div>
      <div class="container">
        <div class="hero-content">
          <p class="hero-eyebrow">Get Started</p>
          <h1 class="hero-headline">Let's Start the Conversation</h1>
          <p class="hero-subheadline">
            Book a diagnostic call or start with a Feasibility Sprint
          </p>
        </div>
      </div>
    </section>

    <!-- Contact Sections (Light Background) -->
    <div class="contact-sections">
      <!-- Combined AI Assistant + Contact Form Section -->
      <section class="contact-section">
        <div class="container">
          <div class="contact-two-col">
            <!-- AI Assistant -->
            <div class="contact-ai-assistant-container">
              <div class="contact-ai-assistant-box">
                <div class="contact-ai-header">
                  <h3>AI Inquiry Assistant</h3>
                  <span class="contact-ai-tag">AI</span>
                </div>
                <p class="contact-ai-intro">
                  Not sure where to start? Ask me about your document automation needs, and I'll help guide you to the
                  right solution.
                </p>
                <div class="contact-chat-window" id="chatContainer">
                  <div class="contact-chat-msg assistant">
                    <div class="contact-msg-bubble">
                      Hi! I'm here to help you find the right document automation solution. What challenges are you facing
                      with document processing?
                    </div>
                  </div>
                </div>
                <div class="contact-chat-input-row">
                  <input
                    type="text"
                    class="contact-chat-field"
                    id="chatInput"
                    placeholder="Ask about invoice automation, beam schedules, or our protocol..."
                  />
                  <button class="contact-chat-mic-btn" id="chatMicBtn" title="Click to speak" aria-label="Voice input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                      <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                      <line x1="12" y1="19" x2="12" y2="23"></line>
                      <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                  </button>
                  <button class="contact-chat-btn" id="chatSendBtn">Send</button>
                </div>
                <div id="suggestedInterest" class="contact-interest-suggestion contact-hidden"></div>

                <!-- Email Chat Log Section -->
                <div class="contact-email-toggle-wrapper">
                  <button class="contact-email-toggle-btn" id="emailChatToggleBtn">
                    <span>üìß</span>
                    <span>Email this conversation</span>
                    <span class="toggle-arrow">‚ñº</span>
                  </button>
                </div>
                <div class="contact-email-section contact-hidden" id="emailChatSection">
                  <p class="contact-email-section-desc">
                    Get a copy of our conversation sent to your email for your records.
                  </p>
                  <div class="contact-email-form-row">
                    <div class="contact-email-field-group">
                      <label for="emailInput">Your Email Address</label>
                      <input type="email" class="contact-email-field" id="emailInput" placeholder="your.email@example.com" />
                    </div>
                    <button class="contact-email-btn" id="emailChatBtn">Send Email</button>
                  </div>
                  <div id="emailStatus"></div>
                </div>
              </div>
            </div>

            <!-- Contact Form -->
            <div class="contact-form-box">
              <h2>Contact Us</h2>
              <form id="contactForm" action="#" method="POST">
                <div class="contact-form-field">
                  <label for="name">Full Name *</label>
                  <input type="text" id="name" name="name" required />
                </div>

                <div class="contact-form-field">
                  <label for="email">Email Address *</label>
                  <input type="email" id="email" name="email" required />
                </div>

                <div class="contact-form-field">
                  <label for="company">Company Name</label>
                  <input type="text" id="company" name="company" />
                </div>

                <div class="contact-form-field">
                  <label for="interest">I'm interested in:</label>
                  <select id="interest" name="interest">
                    <option value="">Select an option</option>
                    <option value="phase-1">Phase 1 - Feasibility Sprint</option>
                    <option value="phase-2">Phase 2 - The Roadmap</option>
                    <option value="phase-3">Phase 3 - Compliance Shield</option>
                    <option value="phase-4">Phase 4 - Implementation</option>
                    <option value="roi">ROI Calculator</option>
                    <option value="general">General Inquiry</option>
                  </select>
                </div>

                <div class="contact-form-field">
                  <label for="message">Message *</label>
                  <textarea
                    id="message"
                    name="message"
                    required
                    placeholder="Tell us about your current challenges or what you'd like to learn more about..."
                  ></textarea>
                  <div id="message-relevance-warning" class="message-relevance-warning contact-hidden">
                    <strong>‚ö†Ô∏è Note:</strong> Your message doesn't appear to be related to our services (document automation, AI implementation, structural engineering workflows, or the Curam-Ai Protocol). We may not be able to assist with your inquiry. Please consider if your question relates to our services before submitting.
                  </div>
                </div>

                <div class="contact-form-submit">
                  <button type="submit" class="btn btn-primary">Send Message</button>
                  <div id="form-message" class="form-message contact-hidden"></div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- Alternative Contact Methods -->
      <section class="contact-section">
        <div class="container">
          <h2 class="section-headline">Other Ways to Reach Us</h2>
          <div class="contact-alt-grid">
            <div class="contact-alt-card">
              <h3>Book a Call</h3>
              <p>Schedule a 30-minute diagnostic call to discuss your needs.</p>
              <a href="#" class="btn btn-secondary">Schedule Now</a>
            </div>
            <div class="contact-alt-card">
              <h3>Calculate ROI</h3>
              <p>Use our ROI calculator to understand the financial impact.</p>
              <a href="roi.html" class="btn btn-secondary">Open Calculator</a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <!-- Footer -->
    <div id="footer-placeholder"></div>
    <script src="assets/js/footer-loader.js"></script>

    <script src="assets/js/scripts.js"></script>
    <script>
      // Pre-select interest option from URL parameter
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const option = urlParams.get('option');
        const interestSelect = document.getElementById('interest');
        
        if (option && interestSelect) {
          // Set the value if it exists in the dropdown
          const optionExists = Array.from(interestSelect.options).some(opt => opt.value === option);
          if (optionExists) {
            interestSelect.value = option;
          }
        }
      })();

      // AI Contact Assistant
      const chatContainer = document.getElementById('chatContainer');
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      const chatMicBtn = document.getElementById('chatMicBtn');
      const suggestedInterestDiv = document.getElementById('suggestedInterest');
      const interestSelect = document.getElementById('interest');
      const messageTextarea = document.getElementById('message');

      let conversationHistory = [];
      let audioContext = null;
      
      // Speech Recognition
      let recognition = null;
      let isRecording = false;
      
      // Initialize Speech Recognition
      function initSpeechRecognition() {
          // Check browser support
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          
          if (!SpeechRecognition) {
              console.warn('Speech recognition not supported in this browser');
              chatMicBtn.disabled = true;
              chatMicBtn.title = 'Voice input not supported in this browser';
              chatMicBtn.classList.add('error');
              return false;
          }
          
          try {
              recognition = new SpeechRecognition();
              recognition.continuous = false; // Stop after first result
              recognition.interimResults = false; // Only return final results
              recognition.lang = 'en-US'; // Set language
              
              recognition.onstart = function() {
                  isRecording = true;
                  chatMicBtn.classList.add('recording');
                  chatMicBtn.title = 'Listening... Click to stop';
                  chatInput.placeholder = 'Listening...';
              };
              
              recognition.onresult = function(event) {
                  const transcript = event.results[0][0].transcript;
                  chatInput.value = transcript;
                  // Auto-send if user wants (optional - commented out for now)
                  // sendChatMessage();
              };
              
              recognition.onerror = function(event) {
                  console.error('Speech recognition error:', event.error);
                  isRecording = false;
                  chatMicBtn.classList.remove('recording');
                  chatInput.placeholder = 'Ask about invoice automation, beam schedules, or our protocol...';
                  
                  let errorMsg = 'Voice input error. ';
                  switch(event.error) {
                      case 'no-speech':
                          errorMsg += 'No speech detected.';
                          break;
                      case 'audio-capture':
                          errorMsg += 'Microphone not found.';
                          chatMicBtn.classList.add('error');
                          break;
                      case 'not-allowed':
                          errorMsg += 'Microphone permission denied.';
                          chatMicBtn.classList.add('error');
                          break;
                      case 'network':
                          errorMsg += 'Network error.';
                          break;
                      default:
                          errorMsg += 'Please try again.';
                  }
                  
                  chatMicBtn.title = errorMsg;
                  setTimeout(() => {
                      chatMicBtn.classList.remove('error');
                      chatMicBtn.title = 'Click to speak';
                  }, 3000);
              };
              
              recognition.onend = function() {
                  isRecording = false;
                  chatMicBtn.classList.remove('recording');
                  chatInput.placeholder = 'Ask about invoice automation, beam schedules, or our protocol...';
                  chatMicBtn.title = 'Click to speak';
              };
              
              return true;
          } catch (error) {
              console.error('Failed to initialize speech recognition:', error);
              chatMicBtn.disabled = true;
              chatMicBtn.title = 'Voice input unavailable';
              return false;
          }
      }
      
      // Toggle speech recognition
      function toggleSpeechRecognition() {
          if (!recognition) {
              if (!initSpeechRecognition()) {
                  return;
              }
          }
          
          if (isRecording) {
              // Stop recording
              recognition.stop();
          } else {
              // Start recording
              try {
                  recognition.start();
              } catch (error) {
                  // Already started or other error
                  console.log('Recognition start error:', error);
              }
          }
      }
      
      // Initialize on page load
      initSpeechRecognition();

      // Initialize audio context on first user interaction
      function initAudioContext() {
          if (!audioContext) {
              try {
                  audioContext = new (window.AudioContext || window.webkitAudioContext)();
              } catch (error) {
                  console.log('Could not initialize audio context:', error);
              }
          }
          // Resume audio context if it's suspended (required by some browsers)
          if (audioContext && audioContext.state === 'suspended') {
              audioContext.resume();
          }
      }

      // Function to play notification sound when AI responds
      function playNotificationSound() {
          try {
              // Ensure audio context is initialized
              if (!audioContext) {
                  initAudioContext();
              }
              
              if (!audioContext) return;
              
              // Resume if suspended
              if (audioContext.state === 'suspended') {
                  audioContext.resume();
              }
              
              // Create a pleasant notification sound (gentle chime)
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              
              // Set frequency for a pleasant tone (gentle descending chime)
              oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
              
              // Set volume envelope (fade in and out)
              gainNode.gain.setValueAtTime(0, audioContext.currentTime);
              gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
              gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
              
              // Use a sine wave for a smooth, pleasant sound
              oscillator.type = 'sine';
              
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.2);
          } catch (error) {
              // Silently fail if audio context is not available (e.g., autoplay restrictions)
              console.log('Could not play notification sound:', error);
          }
      }

      function sanitizeHtml(html) {
          // Parse the HTML safely using DOMParser
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Remove dangerous elements (but allow buttons for follow-up questions)
          const dangerous = doc.querySelectorAll('script, style, iframe, object, embed, form, input, link, meta');
          dangerous.forEach(el => el.remove());
          
          // Remove dangerous attributes from all elements
          const allElements = doc.querySelectorAll('*');
          allElements.forEach(el => {
              // Remove all attributes except safe ones
              Array.from(el.attributes).forEach(attr => {
                  const attrName = attr.name.toLowerCase();
                  if (attrName === 'href' && el.tagName === 'A') {
                      // Only allow http/https links
                      if (!attr.value.match(/^https?:\/\//i)) {
                          el.removeAttribute(attrName);
                      }
                  } else if (attrName === 'onclick' && el.tagName === 'BUTTON' && el.classList.contains('chat-followup-btn')) {
                      // Allow onclick for follow-up buttons (they're generated by us)
                      // Keep it
                  } else if (!['class', 'id', 'style'].includes(attrName)) {
                      el.removeAttribute(attrName);
                  }
              });
          });
          
          // Get sanitized HTML
          return doc.body.innerHTML;
      }
      
      function addMessageToChat(role, content) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `contact-chat-msg ${role}`;
          
          // If content doesn't contain HTML tags, format it
          let formattedContent = content;
          if (!content.includes('<') || !content.includes('>')) {
              // Convert plain text to HTML
              formattedContent = formatTextToHtml(content);
          } else {
              // Sanitize existing HTML
              formattedContent = sanitizeHtml(content);
          }
          
          messageDiv.innerHTML = `<div class="contact-msg-bubble">${formattedContent}</div>`;
          chatContainer.appendChild(messageDiv);
          // REMOVED - no auto-scroll: chatContainer.scrollTop = chatContainer.scrollHeight;

          // Add to conversation history (store original content)
          conversationHistory.push({ role, content });

          // Play sound when assistant responds
          if (role === 'assistant') {
              playNotificationSound();
          }
      }
      
      function formatTextToHtml(text) {
          if (!text) return '';
          
          // Split by double newlines (paragraphs)
          const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim());
          
          if (paragraphs.length === 0) {
              return `<p>${escapeHtml(text)}</p>`;
          }
          
          let html = '';
          for (const para of paragraphs) {
              const trimmed = para.trim();
              if (!trimmed) continue;
              
              // Replace single newlines with <br>
              let formatted = trimmed.replace(/\n/g, '<br>');
              
              // Basic markdown-style formatting
              formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
              formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
              
              html += `<p>${formatted}</p>`;
          }
          
          return html || `<p>${escapeHtml(text)}</p>`;
      }
      
      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }

      function showSuggestedInterest(suggestedInterest) {
          if (!suggestedInterest) {
              suggestedInterestDiv.classList.add('contact-hidden');
              return;
          }

          const interestLabels = {
              'phase-1': 'Phase 1 - Feasibility Sprint ($1,500)',
              'phase-2': 'Phase 2 - The Roadmap ($7,500)',
              'phase-3': 'Phase 3 - Compliance Shield ($8-12k)',
              'phase-4': 'Phase 4 - Implementation ($20-30k)',
              'roi': 'ROI Calculator'
          };

          suggestedInterestDiv.innerHTML = `
              <strong>üí° Suggested:</strong> Based on our conversation, you might be interested in
              <strong>${interestLabels[suggestedInterest] || suggestedInterest}</strong>.
              <a href="#" onclick="document.getElementById('interest').value='${suggestedInterest}'; return false;">Apply to form</a>
          `;
          suggestedInterestDiv.classList.remove('contact-hidden');
      }

      async function sendChatMessage() {
          const message = chatInput.value.trim();
          if (!message) return;

          // Add user message to chat
          addMessageToChat('user', message);
          
          // Show loading animation - using search-loading class from styles.css
          const loadingId = 'loading-' + Date.now();
          const loadingHtml = `
            <div class="search-loading" id="${loadingId}">
              <div class="loading-spinner"></div>
              <p>Searching 800+ articles...</p>
            </div>
          `;
          addMessageToChat('assistant', loadingHtml);
          chatInput.value = '';
          const originalBtnContent = chatSendBtn.innerHTML;
          chatSendBtn.disabled = true;
          chatSendBtn.innerHTML = '<span class="contact-loading-spin"></span>';

          try {
              const response = await fetch('/api/contact-assistant', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      message: message,
                      history: conversationHistory
                  })
              });

              const data = await response.json();

              console.log('DEBUG: API response:', data);
              console.log('DEBUG: followup_questions:', data.followup_questions);

              // Remove loading animation
              const loadingElement = document.getElementById(loadingId);
              if (loadingElement) {
                loadingElement.remove();
              }
              if (data.error) {
                  addMessageToChat('assistant', "I'm sorry, I encountered an error. Please feel free to fill out the form below or contact us directly.");
              } else {
                  addMessageToChat('assistant', data.message);

                // Display sources separated by type
                if (data.sources && (data.sources.website?.length > 0 || data.sources.blog?.length > 0)) {
                  let sourcesHtml = '<div class="contact-chat-sources" style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(212, 175, 55, 0.12) 100%); border-left: 4px solid var(--color-gold); border-radius: 8px; font-size: 0.9rem;">';
                  
                  // Website sources
                  if (data.sources.website && data.sources.website.length > 0) {
                    sourcesHtml += '<div style="margin-bottom: 12px;">';
                    sourcesHtml += '<p style="margin: 0 0 8px 0; font-weight: 700; color: var(--color-navy); font-size: 0.85rem;">üìÑ FROM WEBSITE:</p>';
                    sourcesHtml += '<ul style="margin: 0; padding-left: 20px; list-style: none;">';
                    data.sources.website.forEach(source => {
                      sourcesHtml += `<li style="margin-bottom: 6px;"><a href="${source.link}" target="_blank" style="color: #0066cc; text-decoration: underline; font-weight: 600; font-size: 0.9rem;">${source.title}</a></li>`;
                    });
                    sourcesHtml += '</ul></div>';
                  }
                  
                  // Blog sources
                  if (data.sources.blog && data.sources.blog.length > 0) {
                    sourcesHtml += '<div>';
                    sourcesHtml += '<p style="margin: 0 0 8px 0; font-weight: 700; color: var(--color-navy); font-size: 0.85rem;">üìö FROM BLOG:</p>';
                    sourcesHtml += '<ul style="margin: 0; padding-left: 20px; list-style: none;">';
                    data.sources.blog.forEach(source => {
                      sourcesHtml += `<li style="margin-bottom: 6px;"><a href="${source.link}" target="_blank" style="color: #0066cc; text-decoration: underline; font-weight: 600; font-size: 0.9rem;">${source.title}</a></li>`;
                    });
                    sourcesHtml += '</ul></div>';
                  }
                  
                  sourcesHtml += '</div>';
                  addMessageToChat('assistant', sourcesHtml);
                }

                // Display follow-up questions (independent of sources)
                if (data.followup_questions && data.followup_questions.length > 0) {
                  console.log('DEBUG: Building follow-up HTML with', data.followup_questions.length, 'questions');
                  let followupHtml = '<div class="chat-followup">';
                  followupHtml += '<p>üí° You might also want to know:</p>';
                  data.followup_questions.forEach(question => {
                    followupHtml += `<button class="chat-followup-btn" onclick="document.getElementById('chatInput').value = '${question}'; document.getElementById('chatSendBtn').click();">${question}</button>`;
                  });
                  followupHtml += '</div>';
                  console.log('DEBUG: Follow-up HTML:', followupHtml);
                  addMessageToChat('assistant', followupHtml);
                  console.log('DEBUG: Follow-up questions added to chat');
                } else {
                  console.log('DEBUG: No follow-up questions to display', data.followup_questions);
                }

                  // Show suggested interest if provided
                  if (data.suggested_interest) {
                      showSuggestedInterest(data.suggested_interest);
                  }

                  // Email section is now toggleable via button - no auto-show
              }
          } catch (error) {
              // Remove loading animation on error
              const loadingElement = document.getElementById(loadingId);
              if (loadingElement) {
                loadingElement.remove();
              }
              console.error('Chat error:', error);
              addMessageToChat('assistant', "I'm having trouble connecting right now. Please fill out the form below and we'll get back to you.");
          } finally {
              chatSendBtn.disabled = false;
              chatSendBtn.innerHTML = originalBtnContent || 'Send';
          }
      }

      // Email chat log functionality
      const emailChatToggleBtn = document.getElementById('emailChatToggleBtn');
      const emailChatSection = document.getElementById('emailChatSection');
      const emailChatBtn = document.getElementById('emailChatBtn');
      const emailInput = document.getElementById('emailInput');
      const emailStatus = document.getElementById('emailStatus');
      const nameInput = document.getElementById('name');
      const companyInput = document.getElementById('company');
      
      // Toggle email section visibility
      if (emailChatToggleBtn && emailChatSection) {
          emailChatToggleBtn.addEventListener('click', function() {
              const isHidden = emailChatSection.classList.contains('contact-hidden');
              const arrow = this.querySelector('.toggle-arrow');
              
              if (isHidden) {
                  emailChatSection.classList.remove('contact-hidden');
                  if (arrow) arrow.textContent = '‚ñ≤';
                  this.classList.add('active');
              } else {
                  emailChatSection.classList.add('contact-hidden');
                  if (arrow) arrow.textContent = '‚ñº';
                  this.classList.remove('active');
              }
          });
      }

      // Pre-fill email from form if available
      const emailFormInput = document.getElementById('email');
      if (emailFormInput) {
          emailFormInput.addEventListener('blur', function() {
              if (this.value && !emailInput.value) {
                  emailInput.value = this.value;
              }
          });
      }

      emailChatBtn.addEventListener('click', async function() {
          const email = emailInput.value.trim();
          if (!email) {
              emailStatus.innerHTML = '<div class="contact-email-err">Please enter your email address.</div>';
              return;
          }

          if (conversationHistory.length === 0) {
              emailStatus.innerHTML = '<div class="contact-email-err">No conversation to email.</div>';
              return;
          }

          emailChatBtn.disabled = true;
          emailChatBtn.textContent = 'Sending...';
          emailStatus.innerHTML = '';

          try {
              const response = await fetch('/api/email-chat-log', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      email: email,
                      history: conversationHistory,
                      name: nameInput ? nameInput.value.trim() : '',
                      company: companyInput ? companyInput.value.trim() : ''
                  })
              });

              const data = await response.json();

              if (data.error) {
                  emailStatus.innerHTML = `<div class="contact-email-err">Error: ${data.error}</div>`;
              } else {
                  emailStatus.innerHTML = '<div class="contact-email-ok">‚úì Chat log sent successfully! Check your email.</div>';
                  emailInput.value = '';
              }
          } catch (error) {
              console.error('Email error:', error);
              emailStatus.innerHTML = '<div class="email-err">Failed to send email. Please try again later.</div>';
          } finally {
              emailChatBtn.disabled = false;
              emailChatBtn.textContent = 'Send Email';
          }
      });

      // Initialize audio context on first user interaction
      chatSendBtn.addEventListener('click', function() {
          initAudioContext();
          sendChatMessage();
      });
      chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
              initAudioContext();
              sendChatMessage();
          }
      });
      
      // Also initialize on any click in the chat area (for better browser compatibility)
      chatInput.addEventListener('focus', initAudioContext);
      
      // Microphone button click handler
      if (chatMicBtn) {
          chatMicBtn.addEventListener('click', function() {
              initAudioContext(); // Initialize audio context for microphone access
              toggleSpeechRecognition();
          });
      }

      // Message relevance validation using NLP (same as AI assistant)
      // Note: messageTextarea is already declared above
      const relevanceWarning = document.getElementById('message-relevance-warning');
      
      let relevanceCheckInProgress = false;
      let lastCheckedMessage = '';
      let cachedResult = null;
      
      async function checkMessageRelevance(message) {
          if (!message || message.trim().length < 10) {
              return { isRelevant: true, confidence: 1.0, reason: 'Message too short to analyze' };
          }
          
          // Use cached result if message hasn't changed
          if (message === lastCheckedMessage && cachedResult !== null) {
              return cachedResult;
          }
          
          if (relevanceCheckInProgress) {
              // If check in progress, return cached result if available, otherwise return null
              return cachedResult;
          }
          
          relevanceCheckInProgress = true;
          lastCheckedMessage = message;
          
          try {
              const response = await fetch('/api/check-message-relevance', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ message: message })
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const data = await response.json();
              console.log('API response data:', data);
              
              // Parse is_relevant - handle boolean, string, or undefined
              let isRelevant = true; // Default to true
              if (data.is_relevant === false || data.is_relevant === 'false') {
                  isRelevant = false;
              } else if (data.is_relevant === true || data.is_relevant === 'true') {
                  isRelevant = true;
              }
              
              const result = {
                  isRelevant: isRelevant,
                  confidence: parseFloat(data.confidence) || 0.5,
                  reason: data.reason || 'Analyzed by AI'
              };
              
              console.log('Parsed result:', result);
              console.log('isRelevant value:', result.isRelevant, 'type:', typeof result.isRelevant);
              
              // Cache the result
              cachedResult = result;
              
              return result;
          } catch (error) {
              console.error('Relevance check error:', error);
              // On error, default to allowing submission
              const errorResult = { isRelevant: true, confidence: 0.5, reason: 'Check unavailable' };
              cachedResult = errorResult;
              return errorResult;
          } finally {
              relevanceCheckInProgress = false;
          }
      }
      
      async function updateRelevanceWarning() {
          if (!messageTextarea) {
              console.error('Message textarea not found');
              return;
          }
          
          if (!relevanceWarning) {
              console.error('Relevance warning element not found. Looking for #message-relevance-warning');
              return;
          }
          
          const message = messageTextarea.value.trim();
          
          if (message.length < 10) {
              relevanceWarning.classList.add('contact-hidden');
              cachedResult = null; // Clear cache when message is too short
              lastCheckedMessage = '';
              return;
          }
          
          // Clear cache if message changed
          if (message !== lastCheckedMessage) {
              cachedResult = null;
          }
          
          try {
              const result = await checkMessageRelevance(message);
              
              if (result) {
                  console.log('Relevance check result:', result);
                  
                  // Show warning if message is not relevant
                  // We show it if isRelevant is false, regardless of confidence
                  // (confidence can be used for other purposes, but if it's not relevant, we warn)
                  if (!result.isRelevant) {
                      console.log('Message is not relevant - showing warning');
                      relevanceWarning.classList.remove('contact-hidden');
                  } else {
                      console.log('Message is relevant - hiding warning');
                      // Hide warning if relevant
                      relevanceWarning.classList.add('contact-hidden');
                  }
              } else {
                  console.log('No result from relevance check');
              }
              // If no result (e.g., check in progress or error), keep current state
          } catch (error) {
              console.error('Error updating relevance warning:', error);
              // On error, hide warning to not block user
              relevanceWarning.classList.add('contact-hidden');
          }
      }
      
      // Check relevance as user types (with debounce)
      let relevanceCheckTimeout;
      messageTextarea.addEventListener('input', function() {
          clearTimeout(relevanceCheckTimeout);
          // Clear cache when user types new content
          if (this.value.trim() !== lastCheckedMessage) {
              cachedResult = null;
          }
          relevanceCheckTimeout = setTimeout(updateRelevanceWarning, 1000); // 1 second debounce for API calls
      });
      
      // Also check on blur
      messageTextarea.addEventListener('blur', updateRelevanceWarning);
      
      // Form submission handler
      const formMessage = document.getElementById('form-message');
      
      function showFormMessage(message, isError = false) {
          formMessage.textContent = message;
          formMessage.className = 'form-message ' + (isError ? 'form-message-error' : 'form-message-success');
          formMessage.classList.remove('contact-hidden');
          
          // // DISABLED: Scroll to message
          formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          
          // Hide message after 5 seconds for success, keep error visible
          if (!isError) {
              setTimeout(() => {
                  formMessage.classList.add('contact-hidden');
              }, 5000);
          }
      }
      
      function hideFormMessage() {
          formMessage.classList.add('contact-hidden');
      }
      
      document.getElementById('contactForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const form = this;
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.textContent;
          
          // Hide previous messages
          hideFormMessage();
          
          // Get form data
          const formData = {
              name: document.getElementById('name').value.trim(),
              email: document.getElementById('email').value.trim(),
              company: document.getElementById('company').value.trim(),
              interest: document.getElementById('interest').value,
              message: document.getElementById('message').value.trim()
          };
          
          // Validation
          if (!formData.name || !formData.email || !formData.message) {
              showFormMessage('Please fill in all required fields (Name, Email, and Message).', true);
              return;
          }
          
          // Disable submit button early
          submitBtn.disabled = true;
          submitBtn.textContent = 'Checking...';
          
          // Check message relevance before submission using NLP
          if (formData.message.length > 10) {
              try {
                  const relevanceResult = await checkMessageRelevance(formData.message);
                  
                  if (relevanceResult && !relevanceResult.isRelevant && relevanceResult.confidence < 0.7) {
                      // Re-enable button for user decision
                      submitBtn.disabled = false;
                      submitBtn.textContent = originalBtnText;
                      
                      // Show warning but allow submission
                      const confirmSubmit = confirm(
                          'Your message doesn\'t appear to be related to our services (document automation, AI implementation, or structural engineering workflows). We may not be able to assist with your inquiry. Do you still want to submit?'
                      );
                      if (!confirmSubmit) {
                          return; // User cancelled submission
                      }
                      
                      // Disable again for submission
                      submitBtn.disabled = true;
                      submitBtn.textContent = 'Sending...';
                  }
              } catch (error) {
                  console.error('Relevance check failed on submit:', error);
                  // Continue with submission if check fails
              }
          }
          
          // Update button text if not already updated
          if (submitBtn.textContent !== 'Sending...') {
              submitBtn.textContent = 'Sending...';
          }
          
          try {
              const response = await fetch('/api/contact', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(formData)
              });
              
              const data = await response.json();
              
              if (response.ok && data.success) {
                  // Show success message
                  showFormMessage(data.message || 'Thank you for your message! We will get back to you soon.', false);
                  form.reset();
              } else {
                  // Show error message
                  showFormMessage(data.error || 'Failed to send message. Please try again later.', true);
                  if (data.details) {
                      console.error('Error details:', data.details);
                  }
              }
          } catch (error) {
              console.error('Form submission error:', error);
              showFormMessage('An error occurred while sending your message. Please try again later.', true);
          } finally {
              // Re-enable submit button
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
          }
      });
    </script>
  </body>
</html>