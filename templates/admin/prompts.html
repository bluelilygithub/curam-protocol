{% extends "admin/base.html" %}

{% block title %}Prompt Templates{% endblock %}

{% block content %}
<div class="admin-header">
    <div>
        <h2>Prompt Templates</h2>
        <p style="color: #6B7280; margin: 0.25rem 0 0; font-size: 0.875rem;">Manage AI prompts for document extraction</p>
    </div>
    <div class="admin-header-actions">
        {% if inactive_migrated_count and inactive_migrated_count > 0 %}
        <form method="POST" action="{{ url_for('admin.prompts_activate_all') }}" style="display: inline;">
            <button type="submit" class="btn-admin" onclick="return confirm('Activate all {{ inactive_migrated_count }} migrated prompt(s)? This will enable database prompts for use.');">
                ✓ Activate All Migrated Prompts ({{ inactive_migrated_count }})
            </button>
        </form>
        {% endif %}
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="admin-card" style="background: {% if category == 'success' %}#D1FAE5{% elif category == 'error' %}#FEE2E2{% else %}#DBEAFE{% endif %}; border-left: 3px solid {% if category == 'success' %}#10B981{% elif category == 'error' %}#EF4444{% else %}#3B82F6{% endif %};">
                <p style="margin: 0; color: {% if category == 'success' %}#065F46{% elif category == 'error' %}#991B1B{% else %}#1E40AF{% endif %};">{{ message }}</p>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% if not table_exists %}
<div class="admin-card" style="background: #FEF3C7; border-left: 3px solid #F59E0B;">
    <h3 style="margin: 0 0 0.5rem; color: #92400E;">⚠️ Prompt Templates Table Not Found</h3>
    <p style="margin: 0; color: #92400E;">The <code>prompt_templates</code> table does not exist in your database.</p>
    <p style="margin: 0.5rem 0 0; color: #92400E;">You need to run the database setup SQL first. Check your database migration files.</p>
</div>
{% elif total_prompts_count == 0 %}
<div class="admin-card" style="background: #FEF3C7; border-left: 3px solid #F59E0B;">
    <h3 style="margin: 0 0 0.5rem; color: #92400E;">⚠️ No Prompts Found</h3>
    <p style="margin: 0; color: #92400E;">The <code>prompt_templates</code> table exists but has no prompts.</p>
    <p style="margin: 0.5rem 0 0; color: #92400E;">
        <strong>To migrate prompts:</strong><br>
        1. Run: <code>python extract_prompts_to_sql.py</code> (generates SQL)<br>
        2. Run <code>prompts_migration_generated.sql</code> in your PostgreSQL database
    </p>
</div>
{% elif active_migrated_count > 0 %}
<div class="admin-card" style="background: #D1FAE5; border-left: 3px solid #10B981;">
    <h3 style="margin: 0 0 0.5rem; color: #065F46;">✓ {{ active_migrated_count }} Active Migrated Prompt(s)</h3>
    <p style="margin: 0; color: #065F46;">Your system is using database prompts! The code will check database prompts first, then fallback to hardcoded if needed.</p>
</div>
{% endif %}

<div class="admin-card">
    <h3 style="margin: 0 0 1rem;">All Prompts</h3>
    
    {% if prompts %}
    <table class="admin-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Scope</th>
                <th>Document Type</th>
                <th>Sector</th>
                <th>Priority</th>
                <th>Length</th>
                <th>Status</th>
                <th>Updated</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for prompt in prompts %}
            <tr>
                <td><strong>{{ prompt.get('name', 'N/A') }}</strong></td>
                <td>
                    <span class="badge badge-info">{{ prompt.get('scope', 'N/A') }}</span>
                </td>
                <td>{{ prompt.get('doc_type', '—') or '—' }}</td>
                <td>{{ prompt.get('sector_slug', '—') or '—' }}</td>
                <td>{{ prompt.get('priority', 0) }}</td>
                <td>{{ "{:,}".format(prompt.get('prompt_length', 0)) }} chars</td>
                <td>
                    {% if prompt.get('is_active') %}
                        <span class="badge badge-success">Active</span>
                    {% else %}
                        <span class="badge badge-warning">Inactive</span>
                    {% endif %}
                </td>
                <td>
                    {% if prompt.get('updated_at') %}
                        {{ prompt.get('updated_at').strftime('%Y-%m-%d') if prompt.get('updated_at') else 'N/A' }}
                    {% else %}
                        {{ prompt.get('created_at').strftime('%Y-%m-%d') if prompt.get('created_at') else 'N/A' }}
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{{ url_for('admin.prompt_edit', prompt_id=prompt.get('id')) }}" class="btn-admin" style="text-decoration: none; padding: 0.375rem 0.75rem; font-size: 0.875rem;">Edit</a>
                        <form method="POST" action="{{ url_for('admin.prompt_toggle', prompt_id=prompt.get('id')) }}" style="display: inline;">
                            <button type="submit" class="btn-admin btn-admin-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem; cursor: pointer;">
                                {% if prompt.get('is_active') %}Deactivate{% else %}Activate{% endif %}
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #6B7280; padding: 2rem; text-align: center;">
        No prompt templates found.
    </p>
    {% endif %}
</div>

<div class="admin-card">
    <h3 style="margin: 0 0 1rem;">About Prompt Management</h3>
    <div style="color: #6B7280; line-height: 1.6;">
        <p><strong>Scope Types:</strong></p>
        <ul style="margin: 0.5rem 0;">
            <li><strong>universal</strong> - Applied to all document types</li>
            <li><strong>document_type</strong> - Applied to specific document types (e.g., vendor-invoice, beam-schedule)</li>
            <li><strong>sector</strong> - Applied to specific sectors (e.g., professional-services, built-environment)</li>
        </ul>
        <p style="margin-top: 1rem;"><strong>Priority:</strong> Lower numbers are applied first. Prompts are combined in priority order.</p>
        <p><strong>Active Status:</strong> Only active prompts are used. Inactive prompts are ignored but preserved for reference.</p>
    </div>
</div>
{% endblock %}
