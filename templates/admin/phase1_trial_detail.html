{% extends "admin/base.html" %}

{% block title %}Phase 1 Trial: {{ trial.get('trial_code', 'N/A') }}{% endblock %}

{% block extra_head %}
<style>
    .trial-header-info {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-top: 1rem;
        max-width: 800px;
    }
    
    .trial-info-item {
        background: #F8F9FA;
        padding: 0.75rem;
        border-radius: 6px;
        border-left: 3px solid #D4AF37;
    }
    
    .trial-info-label {
        font-size: 0.875rem;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    
    .trial-info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #0B1221;
    }
    
    .upload-section {
        background: #fff;
        border: 2px dashed #E5E7EB;
        border-radius: 8px;
        padding: 2rem;
        margin: 1.5rem 0;
        text-align: center;
        transition: all 0.2s;
    }
    
    .upload-section:hover {
        border-color: #D4AF37;
        background: #FFFBF0;
    }
    
    .upload-section.drag-over {
        border-color: #D4AF37;
        background: #FFFBF0;
    }
    
    .document-list {
        display: grid;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .document-item {
        background: #F8F9FA;
        padding: 1rem;
        border-radius: 6px;
        border-left: 3px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .document-item.uploaded {
        border-left-color: #10B981;
    }
    
    .document-item.processing {
        border-left-color: #F59E0B;
    }
    
    .document-item.completed {
        border-left-color: #3B82F6;
    }
    
    .results-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin: 1.5rem 0;
    }
    
    .result-card {
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
    }
    
    .result-card.primary {
        border-color: #D4AF37;
        background: linear-gradient(135deg, #FFFBF0, white);
    }
    
    .result-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #0B1221;
        margin: 0.5rem 0;
    }
    
    .result-label {
        color: #6B7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Responsive 2-column layout */
    @media (max-width: 1024px) {
        .config-upload-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div>
        <a href="{{ url_for('admin.phase1_trials') }}" style="color: #D4AF37; text-decoration: none; font-weight: 600; margin-bottom: 0.5rem; display: inline-block;">‚Üê Back to Phase 1 Trials</a>
        <h2>Phase 1 Trial: {{ trial.get('trial_code', 'N/A') }}</h2>
        <div class="trial-header-info">
            <div class="trial-info-item">
                <div class="trial-info-label">Customer</div>
                <div class="trial-info-value">{{ trial.get('customer_name', 'N/A') }}</div>
            </div>
            <div class="trial-info-item">
                <div class="trial-info-label">Company</div>
                <div class="trial-info-value">{{ trial.get('customer_company', '‚Äî') }}</div>
            </div>
            <div class="trial-info-item">
                <div class="trial-info-label">Industry</div>
                <div class="trial-info-value">{{ trial.get('industry', '‚Äî') }}</div>
            </div>
            <div class="trial-info-item">
                <div class="trial-info-label">Status</div>
                <div class="trial-info-value">
                    {% if trial.get('status') == 'completed' %}
                        <span class="badge badge-success">Completed</span>
                    {% elif trial.get('status') == 'processing' %}
                        <span class="badge badge-warning">Processing</span>
                    {% elif trial.get('status') == 'failed' %}
                        <span class="badge badge-error">Failed</span>
                    {% else %}
                        <span class="badge badge-info">Pending</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="admin-header-actions">
        {% if trial.get('status') == 'completed' %}
        <a href="{{ url_for('admin.phase1_trial_report', trial_id=trial.get('id')) }}" class="btn-admin" style="text-decoration: none; margin-right: 0.5rem;">View Report</a>
        {% endif %}
        {% if trial.get('report_token') %}
        <a href="{{ url_for('admin.phase1_report_public', report_token=trial.get('report_token')) }}" target="_blank" class="btn-admin btn-admin-secondary" style="text-decoration: none;">Public Report Link</a>
        {% endif %}
    </div>
</div>

<!-- Trial Metrics Summary -->
{% if trial.get('overall_accuracy') %}
<div class="admin-card">
    <h3>Phase 1 Test Results Summary</h3>
    <div class="results-summary">
        <div class="result-card {% if trial.get('overall_accuracy', 0) >= 90 %}primary{% endif %}">
            <div class="result-label">Test 1: Field Accuracy</div>
            <div class="result-value">{{ "%.1f"|format(trial.get('overall_accuracy', 0)) }}%</div>
            {% if trial.get('overall_accuracy', 0) >= 90 %}
                <span class="badge badge-success" style="margin-top: 0.5rem;">PASS</span>
            {% else %}
                <span class="badge badge-error" style="margin-top: 0.5rem;">FAIL</span>
            {% endif %}
        </div>
        <div class="result-card {% if trial.get('stp_rate', 0) >= 60 %}primary{% endif %}">
            <div class="result-label">Test 2: STP Rate</div>
            <div class="result-value">{{ "%.1f"|format(trial.get('stp_rate', 0)) }}%</div>
            {% if trial.get('stp_rate', 0) >= 60 %}
                <span class="badge badge-success" style="margin-top: 0.5rem;">PASS</span>
            {% else %}
                <span class="badge badge-error" style="margin-top: 0.5rem;">FAIL</span>
            {% endif %}
        </div>
        <div class="result-card {% if trial.get('exceptions_count', 0) < 8 %}primary{% endif %}">
            <div class="result-label">Test 3: Exceptions</div>
            <div class="result-value">{{ trial.get('exceptions_count', 0) }}</div>
            <span style="color: #6B7280; font-size: 0.875rem; margin-top: 0.5rem;">Flagged for Review</span>
        </div>
    </div>
    
    <div style="margin-top: 1.5rem; padding: 1rem; background: {% if trial.get('overall_accuracy', 0) >= 90 and trial.get('stp_rate', 0) >= 60 %}#F0FDF4{% else %}#FEF3C7{% endif %}; border-left: 4px solid {% if trial.get('overall_accuracy', 0) >= 90 and trial.get('stp_rate', 0) >= 60 %}#10B981{% else %}#F59E0B{% endif %}; border-radius: 4px;">
        <strong style="color: #0B1221;">Recommendation:</strong>
        {% if trial.get('overall_accuracy', 0) >= 90 and trial.get('stp_rate', 0) >= 60 %}
            <span style="color: #065F46;">‚úÖ All tests passed. Proceed to Phase 2.</span>
        {% else %}
            <span style="color: #92400E;">‚ö†Ô∏è Tests did not meet thresholds. Review results below or provide refund.</span>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Configuration & Upload Section - 2 Column Layout -->
<div class="admin-card">
    <h3>Document Configuration & Upload</h3>
    <p style="color: #6B7280; margin-bottom: 1.5rem; font-size: 0.875rem;">
        Configure extraction settings for each category and upload documents. Each category may contain different document types requiring different fields.
    </p>
    
    {% set category_configs = trial.get('category_configs', {}) or {} %}
    {% set total_docs = trial.get('total_documents', 0) %}
    {% set category_counts = {'Category 1': 0, 'Category 2': 0, 'Category 3': 0} %}
    {% for doc in documents %}
        {% set cat = doc.get('document_category', 'Category 1') %}
        {% if cat in category_counts %}
            {% set _ = category_counts.update({cat: category_counts[cat] + 1}) %}
        {% endif %}
    {% endfor %}
    
    <!-- 2 Column Layout -->
    <div class="config-upload-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
        
        <!-- Column 1: Configuration -->
        <div>
            <h4 style="margin-bottom: 1rem; color: #0B1221; font-size: 1rem; border-bottom: 2px solid #E5E7EB; padding-bottom: 0.5rem;">Extraction Configuration</h4>
            
            <!-- Category 1 Configuration -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #F8F9FA; border-radius: 8px; border-left: 3px solid #3B82F6;">
                <h5 style="margin-bottom: 0.75rem; color: #0B1221; font-size: 0.875rem; font-weight: 600;">Category 1</h5>
                <div style="margin-bottom: 0.75rem;">
                    <label for="category1-fields" style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0B1221; font-size: 0.75rem;">
                        Fields (comma-separated):
                    </label>
                    <textarea id="category1-fields" name="category1_fields" rows="2" 
                              placeholder='e.g., Vendor, Date, InvoiceNum, Cost, GST'
                              style="width: 100%; padding: 0.5rem; border: 2px solid #E5E7EB; border-radius: 4px; font-family: monospace; font-size: 0.75rem; resize: vertical;">{% if category_configs.get('Category 1', {}).get('fields') %}{{ category_configs['Category 1']['fields'] | join(', ') }}{% endif %}</textarea>
                </div>
                <div>
                    <label for="category1-format" style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0B1221; font-size: 0.75rem;">
                        Output Format:
                    </label>
                    <textarea id="category1-format" name="category1_format" rows="2" 
                              placeholder='e.g., {"type": "invoice", "structure": "flat"}'
                              style="width: 100%; padding: 0.5rem; border: 2px solid #E5E7EB; border-radius: 4px; font-family: monospace; font-size: 0.75rem; resize: vertical;">{% if category_configs.get('Category 1', {}).get('output_format') %}{% if category_configs['Category 1']['output_format'] is string %}{{ category_configs['Category 1']['output_format'] }}{% else %}{{ category_configs['Category 1']['output_format'] | tojson }}{% endif %}{% endif %}</textarea>
                </div>
            </div>
            
            <!-- Category 2 Configuration -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #F8F9FA; border-radius: 8px; border-left: 3px solid #10B981;">
                <h5 style="margin-bottom: 0.75rem; color: #0B1221; font-size: 0.875rem; font-weight: 600;">Category 2</h5>
                <div style="margin-bottom: 0.75rem;">
                    <label for="category2-fields" style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0B1221; font-size: 0.75rem;">
                        Fields (comma-separated):
                    </label>
                    <textarea id="category2-fields" name="category2_fields" rows="2" 
                              placeholder='e.g., Mark, Size, Qty, Length, Grade'
                              style="width: 100%; padding: 0.5rem; border: 2px solid #E5E7EB; border-radius: 4px; font-family: monospace; font-size: 0.75rem; resize: vertical;">{% if category_configs.get('Category 2', {}).get('fields') %}{{ category_configs['Category 2']['fields'] | join(', ') }}{% endif %}</textarea>
                </div>
                <div>
                    <label for="category2-format" style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0B1221; font-size: 0.75rem;">
                        Output Format:
                    </label>
                    <textarea id="category2-format" name="category2_format" rows="2" 
                              placeholder='e.g., {"type": "engineering", "structure": "tabular"}'
                              style="width: 100%; padding: 0.5rem; border: 2px solid #E5E7EB; border-radius: 4px; font-family: monospace; font-size: 0.75rem; resize: vertical;">{% if category_configs.get('Category 2', {}).get('output_format') %}{% if category_configs['Category 2']['output_format'] is string %}{{ category_configs['Category 2']['output_format'] }}{% else %}{{ category_configs['Category 2']['output_format'] | tojson }}{% endif %}{% endif %}</textarea>
                </div>
            </div>
            
            <!-- Category 3 Configuration -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #F8F9FA; border-radius: 8px; border-left: 3px solid #F59E0B;">
                <h5 style="margin-bottom: 0.75rem; color: #0B1221; font-size: 0.875rem; font-weight: 600;">Category 3</h5>
                <div style="margin-bottom: 0.75rem;">
                    <label for="category3-fields" style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0B1221; font-size: 0.75rem;">
                        Fields (comma-separated):
                    </label>
                    <textarea id="category3-fields" name="category3_fields" rows="2" 
                              placeholder='e.g., ShipmentRef, CountryOfOrigin, FTAAgreement'
                              style="width: 100%; padding: 0.5rem; border: 2px solid #E5E7EB; border-radius: 4px; font-family: monospace; font-size: 0.75rem; resize: vertical;">{% if category_configs.get('Category 3', {}).get('fields') %}{{ category_configs['Category 3']['fields'] | join(', ') }}{% endif %}</textarea>
                </div>
                <div>
                    <label for="category3-format" style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #0B1221; font-size: 0.75rem;">
                        Output Format:
                    </label>
                    <textarea id="category3-format" name="category3_format" rows="2" 
                              placeholder='e.g., {"type": "logistics", "structure": "flat"}'
                              style="width: 100%; padding: 0.5rem; border: 2px solid #E5E7EB; border-radius: 4px; font-family: monospace; font-size: 0.75rem; resize: vertical;">{% if category_configs.get('Category 3', {}).get('output_format') %}{% if category_configs['Category 3']['output_format'] is string %}{{ category_configs['Category 3']['output_format'] }}{% else %}{{ category_configs['Category 3']['output_format'] | tojson }}{% endif %}{% endif %}</textarea>
                </div>
            </div>
            
            <form id="extraction-config-form" data-trial-id="{{ trial.get('id') }}">
                <button type="submit" class="btn-admin" style="width: 100%;">üíæ Save Configurations</button>
            </form>
        </div>
        
        <!-- Column 2: File Uploads -->
        <div>
            <h4 style="margin-bottom: 1rem; color: #0B1221; font-size: 1rem; border-bottom: 2px solid #E5E7EB; padding-bottom: 0.5rem;">Document Upload</h4>
            
            <div style="background: #F0FDF4; border-left: 3px solid #10B981; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.75rem;">
                <strong>Progress:</strong> <span style="color: #065F46;">{{ total_docs }}/15 documents</span>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span style="font-size: 0.7rem;">Cat 1: <strong>{{ category_counts['Category 1'] }}/5</strong></span>
                    <span style="font-size: 0.7rem;">Cat 2: <strong>{{ category_counts['Category 2'] }}/5</strong></span>
                    <span style="font-size: 0.7rem;">Cat 3: <strong>{{ category_counts['Category 3'] }}/5</strong></span>
                </div>
            </div>
    
            <!-- Category 1 Upload -->
            <div style="margin-bottom: 1.5rem;">
                <h5 style="margin-bottom: 0.75rem; color: #0B1221; font-size: 0.875rem; font-weight: 600;">Category 1 ({{ category_counts['Category 1'] }}/5)</h5>
                <form class="document-upload-form" data-trial-id="{{ trial.get('id') }}" data-category="Category 1" enctype="multipart/form-data" style="margin-bottom: 0.5rem;">
                    <div class="upload-section" style="padding: 1rem;">
                        <input type="file" id="upload-category1" name="documents" 
                               accept=".pdf" multiple 
                               style="display: none;"
                               data-max-files="5"
                               data-category="Category 1">
                        <label for="upload-category1" style="cursor: pointer; display: block;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.5rem; color: #D4AF37;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <div style="font-weight: 600; color: #0B1221; margin-bottom: 0.25rem; font-size: 0.75rem;">Click or Drag & Drop</div>
                            <div style="color: #6B7280; font-size: 0.7rem;">PDF only (max 5)</div>
                        </label>
                    </div>
                    <button type="submit" class="btn-admin" style="display: none; width: 100%; font-size: 0.75rem; padding: 0.5rem;" data-submit-category="Category 1">Upload</button>
                </form>
            </div>
            
            <!-- Category 2 Upload -->
            <div style="margin-bottom: 1.5rem;">
                <h5 style="margin-bottom: 0.75rem; color: #0B1221; font-size: 0.875rem; font-weight: 600;">Category 2 ({{ category_counts['Category 2'] }}/5)</h5>
                <form class="document-upload-form" data-trial-id="{{ trial.get('id') }}" data-category="Category 2" enctype="multipart/form-data" style="margin-bottom: 0.5rem;">
                    <div class="upload-section" style="padding: 1rem;">
                        <input type="file" id="upload-category2" name="documents" 
                               accept=".pdf" multiple 
                               style="display: none;"
                               data-max-files="5"
                               data-category="Category 2">
                        <label for="upload-category2" style="cursor: pointer; display: block;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.5rem; color: #D4AF37;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <div style="font-weight: 600; color: #0B1221; margin-bottom: 0.25rem; font-size: 0.75rem;">Click or Drag & Drop</div>
                            <div style="color: #6B7280; font-size: 0.7rem;">PDF only (max 5)</div>
                        </label>
                    </div>
                    <button type="submit" class="btn-admin" style="display: none; width: 100%; font-size: 0.75rem; padding: 0.5rem;" data-submit-category="Category 2">Upload</button>
                </form>
            </div>
            
            <!-- Category 3 Upload -->
            <div style="margin-bottom: 1.5rem;">
                <h5 style="margin-bottom: 0.75rem; color: #0B1221; font-size: 0.875rem; font-weight: 600;">Category 3 ({{ category_counts['Category 3'] }}/5)</h5>
                <form class="document-upload-form" data-trial-id="{{ trial.get('id') }}" data-category="Category 3" enctype="multipart/form-data" style="margin-bottom: 0.5rem;">
                    <div class="upload-section" style="padding: 1rem;">
                        <input type="file" id="upload-category3" name="documents" 
                               accept=".pdf" multiple 
                               style="display: none;"
                               data-max-files="5"
                               data-category="Category 3">
                        <label for="upload-category3" style="cursor: pointer; display: block;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.5rem; color: #D4AF37;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <div style="font-weight: 600; color: #0B1221; margin-bottom: 0.25rem; font-size: 0.75rem;">Click or Drag & Drop</div>
                            <div style="color: #6B7280; font-size: 0.7rem;">PDF only (max 5)</div>
                        </label>
                    </div>
                    <button type="submit" class="btn-admin" style="display: none; width: 100%; font-size: 0.75rem; padding: 0.5rem;" data-submit-category="Category 3">Upload</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Document Lists & Processing Button (Full Width Below) -->
    {% if documents %}
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #E5E7EB;">
        <h4 style="margin-bottom: 1rem; color: #0B1221; font-size: 1rem;">Uploaded Documents by Category</h4>
    
    
    {% for category_name in ['Category 1', 'Category 2', 'Category 3'] %}
        {% set category_docs = documents | selectattr('document_category', 'equalto', category_name) | list %}
        {% if category_docs %}
        <div style="margin-bottom: 1.5rem;">
            <h5 style="margin-bottom: 0.75rem; color: #6B7280; font-size: 0.875rem; font-weight: 600;">{{ category_name }}</h5>
            <div class="document-list">
                {% for doc in category_docs %}
                <div class="document-item {{ doc.get('status', 'uploaded') }}">
                    <div>
                        <strong style="color: #0B1221;">{{ doc.get('original_filename', 'Unknown') }}</strong>
                        <div style="color: #6B7280; font-size: 0.875rem; margin-top: 0.25rem;">
                            Doc #{{ doc.get('document_number', '?') }} ‚Ä¢ 
                            {% if doc.get('file_size_bytes') %}
                                {{ "%.1f"|format(doc.get('file_size_bytes', 0) / 1024) }} KB
                            {% endif %}
                            {% if doc.get('status') == 'completed' %}
                                ‚Ä¢ Processed
                            {% elif doc.get('status') == 'processing' %}
                                ‚Ä¢ Processing...
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        {% if doc.get('status') == 'uploaded' %}
                            <span class="badge badge-info">Ready</span>
                        {% elif doc.get('status') == 'processing' %}
                            <span class="badge badge-warning">Processing</span>
                        {% elif doc.get('status') == 'completed' %}
                            <span class="badge badge-success">Completed</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
    {% endif %}
    
    {% if total_docs >= 15 %}
    <div style="margin-top: 1.5rem; padding: 1rem; background: #EFF6FF; border-left: 3px solid #3B82F6; border-radius: 4px; font-size: 0.875rem;">
        <strong style="color: #1E40AF;">Ready to Process:</strong>
        <span style="color: #1E3A8A;">You have {{ total_docs }} documents (15 required). When ready, click below to process all documents and generate the Phase 1 report.</span>
        <form method="POST" action="{{ url_for('admin.phase1_trial_process', trial_id=trial.get('id')) }}" style="margin-top: 1rem;">
            <button type="submit" class="btn-admin">üöÄ Process All Documents</button>
        </form>
    </div>
    {% elif total_docs > 0 %}
    <div style="margin-top: 1.5rem; padding: 1rem; background: #FEF3C7; border-left: 3px solid #F59E0B; border-radius: 4px; font-size: 0.875rem;">
        <strong style="color: #92400E;">Upload In Progress:</strong>
        <span style="color: #78350F;">You have {{ total_docs }}/15 documents uploaded. Please upload documents to all 3 categories (5 per category) before processing.</span>
    </div>
    {% else %}
    <div style="margin-top: 1.5rem; padding: 1rem; background: #FEF3C7; border-left: 3px solid #F59E0B; border-radius: 4px; font-size: 0.875rem;">
        <strong style="color: #92400E;">No Documents Yet:</strong>
        <span style="color: #78350F;">Upload documents to each category above to get started. You need 5 documents per category (15 total).</span>
    </div>
    {% endif %}
</div>

<!-- Results Section (if documents processed) -->
{% if results %}
<div class="admin-card">
    <h3>Extraction Results</h3>
    <p style="color: #6B7280; margin-bottom: 1.5rem;">
        Detailed extraction results for uploaded documents. Review field-level accuracy and confidence scores.
    </p>
    
    {% for result in results %}
    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #F8F9FA; border-radius: 8px; border-left: 3px solid {% if result.get('field_accuracy', 0) >= 90 %}#10B981{% else %}#F59E0B{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
                <h4 style="margin: 0 0 0.5rem; color: #0B1221;">
                    {{ result.get('original_filename', 'Unknown') }}
                    <span style="font-weight: normal; color: #6B7280; font-size: 0.875rem;">
                        ({{ result.get('document_category', 'Unknown') }} - Doc #{{ result.get('document_number', '?') }})
                    </span>
                </h4>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <span class="badge {% if result.get('field_accuracy', 0) >= 90 %}badge-success{% else %}badge-warning{% endif %}">
                        Accuracy: {{ "%.1f"|format(result.get('field_accuracy', 0)) }}%
                    </span>
                    {% if result.get('stp_eligible') %}
                        <span class="badge badge-success">STP Eligible</span>
                    {% else %}
                        <span class="badge badge-warning">Requires Review</span>
                    {% endif %}
                    {% if result.get('requires_human_review') %}
                        <span class="badge badge-error">Exception Flagged</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
            <div>
                <div style="font-size: 0.875rem; color: #6B7280;">Fields Total</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #0B1221;">{{ result.get('fields_total', 0) }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: #6B7280;">Fields Passed</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #10B981;">{{ result.get('fields_passed', 0) }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: #6B7280;">Fields Flagged</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #F59E0B;">{{ result.get('fields_flagged', 0) }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: #6B7280;">Processing Time</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #0B1221;">
                    {% if result.get('processing_time_ms') %}
                        {{ "%.2f"|format(result.get('processing_time_ms', 0) / 1000) }}s
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if result.get('confidence_scores') %}
        <details style="margin-top: 1rem;">
            <summary style="cursor: pointer; color: #0B1221; font-weight: 600; padding: 0.5rem; background: white; border-radius: 4px;">
                View Field-Level Confidence Scores
            </summary>
            <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;">
                <table style="width: 100%; font-size: 0.875rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid #E5E7EB;">
                            <th style="text-align: left; padding: 0.5rem;">Field</th>
                            <th style="text-align: left; padding: 0.5rem;">Confidence</th>
                            <th style="text-align: left; padding: 0.5rem;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for field, confidence in result.get('confidence_scores', {}).items() %}
                        <tr style="border-bottom: 1px solid #F3F4F6;">
                            <td style="padding: 0.5rem;"><strong>{{ field }}</strong></td>
                            <td style="padding: 0.5rem;">{{ "%.1f"|format(confidence) }}%</td>
                            <td style="padding: 0.5rem;">
                                {% if confidence >= 90 %}
                                    <span class="badge badge-success">PASS</span>
                                {% else %}
                                    <span class="badge badge-warning">FLAG</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
        {% endif %}
        
        {% if result.get('validation_errors') %}
        <div style="margin-top: 1rem; padding: 1rem; background: #FEF3C7; border-left: 3px solid #F59E0B; border-radius: 4px;">
            <strong style="color: #92400E;">Validation Errors:</strong>
            <ul style="margin: 0.5rem 0 0; padding-left: 1.5rem; color: #78350F;">
                {% for error in result.get('validation_errors', []) %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Private Report Link Section -->
{% if trial.get('report_token') and trial.get('status') == 'completed' %}
<div class="admin-card" style="background: linear-gradient(135deg, #FFFBF0, white); border: 2px solid #D4AF37;">
    <h3 style="color: #0B1221; margin-bottom: 1rem;">üîó Share Private Report with Customer</h3>
    <p style="color: #4B5563; margin-bottom: 1rem;">
        This secure link allows the customer to view their Phase 1 report without requiring a login. 
        The token provides private access to this specific trial's results.
    </p>
    <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #E5E7EB; margin-bottom: 1rem;">
        <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Private Report URL</div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="report-url" 
                   value="{{ request.host_url }}phase1-report/{{ trial.get('report_token') }}"
                   readonly
                   style="flex: 1; padding: 0.75rem; border: 1px solid #E5E7EB; border-radius: 6px; font-family: monospace; font-size: 0.875rem; background: #F8F9FA;">
            <button onclick="copyReportUrl()" class="btn-admin" style="white-space: nowrap;">Copy URL</button>
        </div>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <a href="{{ url_for('admin.phase1_report_public', report_token=trial.get('report_token')) }}" target="_blank" class="btn-admin" style="text-decoration: none;">Preview Report</a>
        <a href="mailto:{{ trial.get('customer_email', '') }}?subject=Phase%201%20Feasibility%20Report&body=Please%20find%20your%20Phase%201%20report%20at:%20{{ request.host_url }}phase1-report/{{ trial.get('report_token') }}" 
           class="btn-admin btn-admin-secondary" 
           style="text-decoration: none;"
           {% if not trial.get('customer_email') %}onclick="alert('Customer email not set'); return false;"{% endif %}>Email Link</a>
    </div>
</div>
{% endif %}

<script>
// File upload handling for multiple categories
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.document-upload-form');
    if (forms.length === 0) return;
    
    const trialId = forms[0].dataset.trialId;
    const totalMaxFiles = 15;
    const categoryMaxFiles = 5;
    let currentDocCount = parseInt('{{ trial.get("total_documents", 0) }}') || 0;
    
    // Category document counts (for per-category limits)
    const categoryCounts = {
        'Category 1': parseInt('{{ category_counts["Category 1"] }}') || 0,
        'Category 2': parseInt('{{ category_counts["Category 2"] }}') || 0,
        'Category 3': parseInt('{{ category_counts["Category 3"] }}') || 0
    };
    
    // Setup each category form
    forms.forEach(form => {
        const input = form.querySelector('input[type="file"]');
        const uploadSection = form.querySelector('.upload-section');
        const submitBtn = form.querySelector('button[type="submit"]');
        const category = form.dataset.category || 'Category 1';
        const categoryCount = categoryCounts[category] || 0;
    
        // Show submit button when files selected
        input.addEventListener('change', function() {
            const files = Array.from(this.files);
            const pdfFiles = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
            const nonPdfFiles = files.filter(f => !f.name.toLowerCase().endsWith('.pdf'));
            
            // Filter out non-PDF files
            if (nonPdfFiles.length > 0) {
                alert('Only PDF files are allowed. ' + nonPdfFiles.length + ' non-PDF file(s) will be ignored.');
                const dt = new DataTransfer();
                pdfFiles.forEach(file => dt.items.add(file));
                this.files = dt.files;
            }
            
            if (pdfFiles.length > 0) {
                // Check category limit (5 per category)
                const categoryAfterUpload = categoryCount + pdfFiles.length;
                if (categoryAfterUpload > categoryMaxFiles) {
                    alert(`${category} can only have ${categoryMaxFiles} files. You currently have ${categoryCount}. You can only upload ${categoryMaxFiles - categoryCount} more file(s).`);
                    const dt = new DataTransfer();
                    pdfFiles.slice(0, categoryMaxFiles - categoryCount).forEach(file => dt.items.add(file));
                    this.files = dt.files;
                    if (this.files.length > 0) {
                        submitBtn.style.display = 'inline-block';
                        const labelText1 = uploadSection.querySelector('label > div:last-child');
                        if (labelText1) labelText1.textContent = `${this.files.length} file(s) selected`;
                    }
                    return;
                }
                
                // Check total limit (15 across all categories)
                const totalAfterUpload = currentDocCount + pdfFiles.length;
                if (totalAfterUpload > totalMaxFiles) {
                    alert(`Maximum of ${totalMaxFiles} files allowed across all categories. You currently have ${currentDocCount} files. You can only upload ${totalMaxFiles - currentDocCount} more file(s).`);
                    const dt = new DataTransfer();
                    pdfFiles.slice(0, totalMaxFiles - currentDocCount).forEach(file => dt.items.add(file));
                    this.files = dt.files;
                    if (this.files.length > 0) {
                        submitBtn.style.display = 'inline-block';
                        const labelText1 = uploadSection.querySelector('label > div:last-child');
                        if (labelText1) labelText1.textContent = `${this.files.length} file(s) selected`;
                    }
                    return;
                }
                
                submitBtn.style.display = 'inline-block';
                const labelText = uploadSection.querySelector('label > div:last-child');
                if (labelText) {
                    labelText.textContent = `${pdfFiles.length} file(s) selected`;
                }
            } else {
                submitBtn.style.display = 'none';
                const labelText3 = uploadSection.querySelector('label > div:last-child');
                if (labelText3) labelText3.textContent = 'PDF only (max 5)';
            }
        });
        
        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const files = Array.from(input.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
            if (files.length === 0) {
                alert('Please select at least one PDF file to upload');
                return;
            }
            
            // Check limits again
            const catCount = categoryCounts[category] || 0;
            if (catCount + files.length > categoryMaxFiles) {
                alert(`${category} can only have ${categoryMaxFiles} files. You currently have ${catCount}.`);
                return;
            }
            
            const totalAfterUpload = currentDocCount + files.length;
            if (totalAfterUpload > totalMaxFiles) {
                alert(`Maximum of ${totalMaxFiles} files allowed. You currently have ${currentDocCount} files.`);
                return;
            }
            
            const formData = new FormData();
            files.forEach(file => {
                formData.append('documents', file);
            });
            formData.append('category', category);
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            try {
                const response = await fetch(`/admin/phase1-trials/${trialId}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully uploaded ${data.uploaded} document(s) to ${category}`);
                    location.reload(); // Refresh page to show new documents
                } else {
                    alert(`Upload failed: ${data.error || data.errors?.join(', ') || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload';
            input.value = '';
            submitBtn.style.display = 'none';
            const labelText4 = uploadSection.querySelector('label > div:last-child');
            if (labelText4) labelText4.textContent = 'PDF only (max 5)';
            }
        });
        
        // Drag and drop
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });
        
        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
            if (files.length === 0) {
                alert('Please drop PDF files only');
                return;
            }
            
            // Check limits
            const catCount = categoryCounts[category] || 0;
            const allowedForCategory = Math.min(files.length, categoryMaxFiles - catCount);
            const allowedTotal = Math.min(allowedForCategory, totalMaxFiles - currentDocCount);
            
            if (allowedTotal < files.length) {
                alert(`Only ${allowedTotal} file(s) can be dropped (category limit: ${categoryMaxFiles - catCount}, total limit: ${totalMaxFiles - currentDocCount})`);
                files.splice(allowedTotal);
            }
            
            if (files.length === 0) return;
            
            // Create a new FileList-like object
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            // Trigger change event
            input.dispatchEvent(new Event('change', { bubbles: true }));
        });
    });
    
    // Extraction configuration form handling (per-category)
    const extractionForm = document.getElementById('extraction-config-form');
    if (extractionForm) {
        extractionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const trialId = this.dataset.trialId;
            
            // Helper function to parse fields from comma-separated string
            function parseFields(fieldsStr) {
                if (!fieldsStr || !fieldsStr.trim()) return null;
                return fieldsStr.split(',').map(f => f.trim()).filter(f => f.length > 0);
            }
            
            // Helper function to parse output format (try JSON, otherwise store as string)
            function parseOutputFormat(formatStr) {
                if (!formatStr || !formatStr.trim()) return null;
                try {
                    return JSON.parse(formatStr);
                } catch {
                    return formatStr; // Store as string if not valid JSON
                }
            }
            
            // Build category_configs object from all three category forms
            const categoryConfigs = {};
            
            // Category 1
            const cat1Fields = document.getElementById('category1-fields')?.value.trim();
            const cat1Format = document.getElementById('category1-format')?.value.trim();
            if (cat1Fields || cat1Format) {
                categoryConfigs['Category 1'] = {};
                if (cat1Fields) {
                    categoryConfigs['Category 1'].fields = parseFields(cat1Fields);
                }
                if (cat1Format) {
                    categoryConfigs['Category 1'].output_format = parseOutputFormat(cat1Format);
                }
            }
            
            // Category 2
            const cat2Fields = document.getElementById('category2-fields')?.value.trim();
            const cat2Format = document.getElementById('category2-format')?.value.trim();
            if (cat2Fields || cat2Format) {
                categoryConfigs['Category 2'] = {};
                if (cat2Fields) {
                    categoryConfigs['Category 2'].fields = parseFields(cat2Fields);
                }
                if (cat2Format) {
                    categoryConfigs['Category 2'].output_format = parseOutputFormat(cat2Format);
                }
            }
            
            // Category 3
            const cat3Fields = document.getElementById('category3-fields')?.value.trim();
            const cat3Format = document.getElementById('category3-format')?.value.trim();
            if (cat3Fields || cat3Format) {
                categoryConfigs['Category 3'] = {};
                if (cat3Fields) {
                    categoryConfigs['Category 3'].fields = parseFields(cat3Fields);
                }
                if (cat3Format) {
                    categoryConfigs['Category 3'].output_format = parseOutputFormat(cat3Format);
                }
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch(`/admin/phase1-trials/${trialId}/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category_configs: categoryConfigs
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Category extraction configurations saved successfully!');
                    // Optional: reload to show saved data (or just show success message)
                    // location.reload();
                } else {
                    alert(`Failed to save configuration: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Failed to save configuration: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Save All Category Configurations';
            }
        });
    }
});

// Copy report URL to clipboard
function copyReportUrl() {
    const urlInput = document.getElementById('report-url');
    if (!urlInput) return;
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');
    alert('Report URL copied to clipboard!');
}
</script>
{% endblock %}
